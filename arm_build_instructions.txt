# Instructions for building on arm and deploying on docker locally
# Will have to rerun this on a new overleaf version but haven't tested yet

# Main overleaf repo
cd ~/overleaf
git pull
cd server-ce
make all

# Toolkit repo
cd ~/overleaf-toolkit
git pull

# If upgrading -> run script
# Script checks git for newer versions of toolkit
# Note: DO NOT pull latest image from docker (won't even run on ARM); instead, set new version below in config/version
bin/upgrade

#### Version in config/version should have -with-texlive-full at end
#### e.g. 6.0.0-with-texlive-full
#### ^^ Need to update this with new version

# Read version from disk
IMAGE_VERSION_DISK="$(head -n 1 "config/version")"
docker tag sharelatex/sharelatex:main sharelatex/sharelatex:${IMAGE_VERSION_DISK}

# If upgrading
bin/stop

### Now bring up docker stack
bin/up -d
